<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1200, initial-scale=0.35">
<title>Personal Tracker</title>

<style>
body{min-width:1200px;font-family:system-ui,sans-serif;margin:20px}
@media (prefers-color-scheme: dark){
  body{background:#000;color:#fff}
  .card,table,th,td{border-color:#555}
}
@media (prefers-color-scheme: light){
  body{background:#fff;color:#000}
  .card,table,th,td{border-color:#000}
}
:root{--accent:#6aa6ff}
h1{color:var(--accent)}
.small{font-size:12px;opacity:.7}
.card{border:1px solid;border-radius:16px;padding:14px;margin-top:20px}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{border:1px solid;font-size:12px;text-align:center}
th:first-child,td:first-child{width:180px;text-align:left;padding-left:8px}
td.cell{aspect-ratio:1/1;height:26px}
.week-sep{border-right:2px solid}
input.inline{width:100%;border:none;background:transparent;color:inherit;font-size:12px}
.remove-btn{font-size:11px;margin-left:6px;cursor:pointer;opacity:.6}
button{margin-top:8px;padding:6px 12px;border:1px solid var(--accent);background:transparent;color:var(--accent);border-radius:8px}
.sleep-wrap{display:flex;gap:14px;margin-top:10px}
.sleep-left{width:40%}
.sleep-right{width:60%}
svg{width:100%;height:220px}
  #menuWrapper{
  position:fixed;
  top:12px;
  right:14px;
  z-index:999;
}

#menuBtn{
  background:transparent;
  border:none;
  font-size:22px;
  color:currentColor;
  cursor:pointer;
}

#menuDropdown{
  position:absolute;
  right:0;
  top:28px;
  border:1px solid;
  border-radius:8px;
  min-width:140px;
  background:inherit;
  backdrop-filter:blur(6px);
}

.menu-item{
  padding:8px 12px;
  font-size:13px;
  cursor:pointer;
}

.menu-item:hover{
  background:rgba(127,127,127,0.15);
}

.hidden{
  display:none;
}
  .has-sub{position:relative}
.has-sub:hover .submenu{display:block}

.submenu{
  position:absolute;
  right:100%;
  top:0;
  border:1px solid;
  border-radius:8px;
  min-width:180px;
  background:inherit;
}

.submenu .menu-item{
  white-space:nowrap;
}
</style>
</head>

<body>

<h1>üß† Personal Tracker</h1>
<div id="clock" class="small"></div>

<!-- HABITS -->
<div class="card">
<b>Habits</b>
<div id="todayProgress" class="small"></div>
<table id="habitTable"></table>
<button onclick="addHabit()">+ Add habit</button>
</div>

<!-- SLEEP -->
<div class="card">
<b>Sleep Tracker</b>
<div class="sleep-wrap">
  <div class="sleep-left">
    <table id="sleepTable"></table>
  </div>
  <div class="sleep-right card">
    <div class="small">Daily Sleep (hrs)</div>
    <!-- FIX 1: real size -->
    <svg id="sleepGraph" width="700" height="220"></svg>

    <div class="small" style="margin-top:14px">Weekly Breakdown</div>
    <!-- Three-dot menu -->
<div id="menuWrapper">
  <button id="menuBtn">‚ãÆ</button>

  <div id="menuDropdown" class="hidden">
    <div class="menu-item" id="recapBtn">Recap</div>

    <div class="menu-item has-sub">
      Reset ‚ñ∏
      <div class="submenu hidden">
        <div class="menu-item" id="resetAll">Reset whole tracker</div>
        <div class="menu-item" id="resetHabits">Reset habit tracker</div>
        <div class="menu-item" id="resetSleep">Reset sleep tracker</div>
      </div>
    </div>

    <div class="menu-item" id="aboutBtn">About</div>
  </div>
</div>
    <svg id="weeklyGraph" width="700" height="260"></svg>
  </div>
</div>
</div>

<script>
/* ---------- DATE SETUP ---------- */
const now=new Date();
const Y=now.getFullYear();
const M=now.getMonth();
const TODAY=now.getDate();
const DAYS=new Date(Y,M+1,0).getDate();
const KEY=`tracker-${Y}-${M}`;

/* ---------- DATA ---------- */
let data=JSON.parse(localStorage.getItem(KEY))||{
  habits:Array(5).fill().map(()=>({name:"",checks:{}})),
  sleep:{}
};
function save(){localStorage.setItem(KEY,JSON.stringify(data));render();}

/* ---------- CLOCK ---------- */
setInterval(()=>{
  clock.innerText=new Date().toLocaleDateString()+" "+
  new Date().toLocaleTimeString([],{
    hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true
  });
},1000);

/* ---------- HABITS (LOCKED) ---------- */
function addHabit(){data.habits.push({name:"",checks:{}});save();}
function removeHabit(i){data.habits.splice(i,1);save();}
  // typing pause handler
let habitTimers = {};

function habitTyping(index, value){
  clearTimeout(habitTimers[index]);
  habitTimers[index] = setTimeout(()=>{
  commitHabit(index, value);
}, 50); // 50ms pause
}

function commitHabit(index, value){
  data.habits[index].name = value;
  localStorage.setItem(KEY, JSON.stringify(data));
  // ‚ùå NO render() here
}
function toggleHabit(i,d){
  if(d!==TODAY) return; // üîí past + future locked
  data.habits[i].checks[d]=!data.habits[i].checks[d];
  save();
}

function renderHabits(){
  habitTable.innerHTML="";
  let h="<tr><th>Habit</th>";
  for(let d=1;d<=DAYS;d++){
    const sep=new Date(Y,M,d).getDay()===0;
    h+=`<th class="${sep?'week-sep':''}">${d}</th>`;
  }
  habitTable.innerHTML=h+"</tr>";

  let done=0;
  data.habits.forEach((hb,i)=>{
    let r=`<tr><td>
  <input class="inline" value="${hb.name}" placeholder="Enter habit"
    oninput="habitTyping(${i}, this.value)"
    onkeydown="if(event.key==='Enter'){this.blur()}"
    onblur="commitHabit(${i}, this.value)">

  <span class="remove-btn" onclick="removeHabit(${i})">√ó</span>
  <span class="remove-btn" onclick="moveHabit(${i}, -1)">‚¨ÜÔ∏è</span>
  <span class="remove-btn" onclick="moveHabit(${i}, 1)">‚¨áÔ∏è</span>
</td>`;
    for(let d=1;d<=DAYS;d++){
      const sep=new Date(Y,M,d).getDay()===0;
      if(d===TODAY&&hb.checks[d])done++;
      r+=`<td class="cell ${sep?'week-sep':''}"
        onclick="toggleHabit(${i},${d})">${hb.checks[d]?'‚úî':''}</td>`;
    }
    habitTable.innerHTML+=r+"</tr>";
  });
  todayProgress.innerText=`Today: ${done}/${data.habits.length}`;
}
function moveHabit(index, direction){
  const newIndex = index + direction;
  if(newIndex < 0 || newIndex >= data.habits.length) return;

  const temp = data.habits[index];
  data.habits[index] = data.habits[newIndex];
  data.habits[newIndex] = temp;

  save();
        }
/* ---------- SLEEP ---------- */
function calcHours(s,e){
  if(!s||!e)return null;
  let a=new Date(`1970-01-01T${s}`);
  let b=new Date(`1970-01-01T${e}`);
  if(b<a)b.setDate(b.getDate()+1);
  return +((b-a)/36e5).toFixed(1);
}

function renderSleep(){
  sleepTable.innerHTML="<tr><th>Day</th><th>Slept</th><th>Woke</th><th>Hrs</th></tr>";
  let daily=[],weeks=[],wi=0;weeks[0]=[];

  for(let d=1;d<=DAYS;d++){
    let date=new Date(Y,M,d);
    if(date.getDay()===0&&d!==1){wi++;weeks[wi]=[]}
    const s=data.sleep[d]||{};
    sleepTable.innerHTML+=`
    <tr>
      <td>${d}</td>
      <td><input type="time" class="inline" value="${s.start||""}"
        onchange="data.sleep[${d}]={...data.sleep[${d}],start:this.value,hrs:calcHours(this.value,data.sleep[${d}]?.end)};save()"></td>
      <td><input type="time" class="inline" value="${s.end||""}"
        onchange="data.sleep[${d}]={...data.sleep[${d}],end:this.value,hrs:calcHours(data.sleep[${d}]?.start,this.value)};save()"></td>
      <td><input type="number" step="0.1" class="inline" value="${s.hrs??""}"
        oninput="data.sleep[${d}]={...data.sleep[${d}],hrs:Number(this.value)};save()"></td>
    </tr>`;
    if(s.hrs!=null){
      daily.push({hrs:s.hrs,label:`${d} Jan`});
      weeks[wi].push({hrs:s.hrs,label:`${d} Jan`});
    }
  }
  drawDaily(daily);
  drawWeekly(weeks);
}

/* ---------- DAILY GRAPH (VISIBLE + THEME SAFE) ---------- */
function drawDaily(data){
  sleepGraph.innerHTML="";
  if(!data.length)return;

  const w=sleepGraph.getAttribute("width");
  const h=sleepGraph.getAttribute("height");
  const p=40,max=10;

  sleepGraph.innerHTML+=`
    <text x="12" y="${h/2}" font-size="11"
      transform="rotate(-90 12 ${h/2})" fill="currentColor">Hours</text>`;

  for(let i=5;i<=10;i++){
    let y=h-p-(i/max)*(h-2*p);
    sleepGraph.innerHTML+=`
      <text x="22" y="${y+4}" font-size="10" fill="currentColor">${i}</text>`;
  }

  data.forEach((d,i)=>{
    let x=p+i*(w-2*p)/(data.length-1||1);
    sleepGraph.innerHTML+=`
      <text x="${x-12}" y="${h-18}" font-size="10" fill="currentColor">${d.label}</text>`;
  });

  sleepGraph.innerHTML+=`
    <text x="${w/2-15}" y="${h-2}" font-size="11" fill="currentColor">Date</text>`;

  let gy=h-p-(8/max)*(h-2*p);
  sleepGraph.innerHTML+=`
    <line x1="${p}" y1="${gy}" x2="${w-p}" y2="${gy}"
      stroke="red" stroke-dasharray="4"/>`;

  let pts=data.map((d,i)=>({
    x:p+i*(w-2*p)/(data.length-1||1),
    y:h-p-(d.hrs/max)*(h-2*p)
  }));
  sleepGraph.innerHTML+=`
    <polyline points="${pts.map(p=>`${p.x},${p.y}`).join(" ")}"
      fill="none" stroke="currentColor"/>`;
  pts.forEach(p=>{
    sleepGraph.innerHTML+=`
      <circle cx="${p.x}" cy="${p.y}" r="3" fill="currentColor"/>`;
  });
}

/* ---------- WEEKLY PIE (AVG + THEME SAFE) ---------- */
function drawWeekly(weeks){
  weeklyGraph.innerHTML="";
  const size=150,r=55,cx=75,cy=75;
  const colors=["#ff6b6b","#feca57","#48dbfb","#1dd1a1","#5f27cd","#54a0ff"];

  weeks.forEach((week,wi)=>{
    if(!week.length)return;
    let total=week.reduce((a,b)=>a+b.hrs,0);
    let avg=(total/week.length).toFixed(1);
    let angle=0;

    const g=document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("transform",`translate(${wi*(size+30)},0)`);

    week.forEach((d,i)=>{
      let slice=(d.hrs/total)*Math.PI*2;
      let x1=cx+r*Math.cos(angle),y1=cy+r*Math.sin(angle);
      angle+=slice;
      let x2=cx+r*Math.cos(angle),y2=cy+r*Math.sin(angle);
      let large=slice>Math.PI?1:0;
      g.innerHTML+=`
        <path d="M ${cx} ${cy} L ${x1} ${y1}
          A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z"
          fill="${colors[i%colors.length]}"/>`;
    });

    g.innerHTML+=`
      <text x="${cx}" y="${cy-2}" text-anchor="middle"
        font-size="13" fill="currentColor">Avg</text>
      <text x="${cx}" y="${cy+14}" text-anchor="middle"
        font-size="13" fill="currentColor">${avg}h</text>
      <text x="${cx-55}" y="${size-6}" font-size="11"
        fill="currentColor">
        Week ${wi+1} (${week[0].label} ‚Äì ${week[week.length-1].label})
      </text>`;
    weeklyGraph.appendChild(g);
  });
}

/* ---------- RENDER ---------- */
function render(){renderHabits();renderSleep();}
render();/* ---------- MENU ACTIONS ---------- */

// Recap
document.getElementById("recapBtn").onclick = () => {

  /* ---- HABITS (only attempted days) ---- */
  let habitDone = 0;
  let habitPossible = 0;
  let attemptedDays = new Set();

  data.habits.forEach(habit => {
    Object.keys(habit.checks).forEach(d => {
      attemptedDays.add(Number(d));
    });
  });

  attemptedDays.forEach(d => {
    data.habits.forEach(habit => {
      habitPossible++;
      if(habit.checks[d]) habitDone++;
    });
  });

  let habitPercent = habitPossible
    ? ((habitDone / habitPossible) * 100)
    : null;

  /* ---- SLEEP (only entered days) ---- */
  let sleepSum = 0;
  let sleepDays = 0;

  Object.values(data.sleep).forEach(s => {
    if(s?.hrs != null){
      sleepSum += s.hrs;
      sleepDays++;
    }
  });

  let avgSleep = sleepDays
    ? (sleepSum / sleepDays)
    : null;

  /* ---- TREND LOGIC ---- */
  let habitTrend = habitPercent != null && habitPercent > 70 ? "üìà" : "üìâ";
  let sleepTrend = avgSleep != null && avgSleep >= 7 ? "üìà" : "üìâ";

  /* ---- DISPLAY ---- */
  alert(
    `üìä Live Recap (Available Data)\n\n` +
    `Habits: ${habitPercent != null ? habitPercent.toFixed(1) : "No data"}% ${habitTrend}\n` +
    `Avg Sleep: ${avgSleep != null ? avgSleep.toFixed(1) : "No data"} hrs ${sleepTrend}\n\n` +
    `Habit days tracked: ${attemptedDays.size}\n` +
    `Sleep days tracked: ${sleepDays}`
  );
};

// Reset whole tracker
document.getElementById("resetAll").onclick = () => {
  if(confirm("Reset EVERYTHING? This cannot be undone.")){
    localStorage.removeItem(KEY);
    location.reload();
  }
};

// Reset only habits
document.getElementById("resetHabits").onclick = () => {
  if(confirm("Reset only HABITS tracker?")){
    data.habits = Array(5).fill().map(()=>({name:"",checks:{}}));
    save();
  }
};

// Reset only sleep
document.getElementById("resetSleep").onclick = () => {
  if(confirm("Reset only SLEEP tracker?")){
    data.sleep = {};
    save();
  }
};

// About (simple placeholder)
document.getElementById("aboutBtn").onclick = () => {
  alert("Personal Tracker\nOffline ‚Ä¢ Local ‚Ä¢ Private");
};
  // Three-dot menu toggle
const menuBtn = document.getElementById("menuBtn");
const menuDropdown = document.getElementById("menuDropdown");

menuBtn.addEventListener("click", ()=>{
  menuDropdown.classList.toggle("hidden");
});

// close menu on outside click
document.addEventListener("click",(e)=>{
  if(!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)){
    menuDropdown.classList.add("hidden");
  }
});
</script>

</body>
</html>
