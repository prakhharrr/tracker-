<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1200, initial-scale=0.35">
<title>Personal Tracker</title>
<link rel="manifest" href="manifest.json">

<style>
body{min-width:1200px;font-family:system-ui,sans-serif;margin:20px}
@media (prefers-color-scheme: dark){body{background:#000;color:#fff}.card,table,th,td{border-color:#555}}
@media (prefers-color-scheme: light){body{background:#fff;color:#000}.card,table,th,td{border-color:#000}}
:root{--accent:#6aa6ff}
h1{color:var(--accent)}
.small{font-size:12px;opacity:.75}
.card{border:1px solid;border-radius:14px;padding:14px;margin-top:20px}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{border:1px solid;font-size:12px;text-align:center}
th:first-child,td:first-child{width:180px;text-align:left;padding-left:8px}
td.cell{aspect-ratio:1/1;height:26px}
td.today{cursor:pointer}
td.locked{opacity:.35}
.week-sep{border-right:2px solid}
input.inline{width:100%;border:none;background:transparent;color:inherit}
.remove-btn{font-size:11px;margin-left:6px;cursor:pointer;opacity:.6}
button{margin-top:8px;padding:6px 12px;border:1px solid var(--accent);background:transparent;color:var(--accent);border-radius:8px}
.sleep-wrap{display:flex;gap:14px;margin-top:10px}
.sleep-left{width:35%}
.sleep-right{width:65%}
svg{width:100%;height:160px}
</style>
</head>

<body>

<h1>ðŸ§  Personal Tracker</h1>
<div id="dateTime" class="small"></div>

<div class="card">
<b>Habits</b>
<div id="todayProgress" class="small"></div>
<table id="habitTable"></table>
<button onclick="addHabit()">+ Add habit</button>
</div>

<div class="card">
<b>Sleep</b><br><br>

<label class="small">Slept at</label><br>
<input type="time" id="sleepStart"><br><br>

<label class="small">Woke up at</label><br>
<input type="time" id="sleepEnd"><br>

<button onclick="saveSleep()">Save</button>
<div id="sleepValue" class="small"></div>

<div class="sleep-wrap">
  <div class="sleep-left">
    <table id="sleepTable"></table>
  </div>
  <div class="sleep-right card">
    <div class="small">Sleep Trend</div>
    <svg id="sleepGraph"></svg>
  </div>
</div>
</div>

<script>
const now=new Date();
const Y=now.getFullYear();
const M=now.getMonth();
const TODAY=now.getDate();
const DAYS=new Date(Y,M+1,0).getDate();
const KEY=`tracker-${Y}-${M}`;

let data=JSON.parse(localStorage.getItem(KEY))||{
  /* ---- ONE-TIME RECOVERY FOR 1 JAN SLEEP ---- */
(function recoverJan1Sleep(){
  const target = `${Y}-01-01`;

  if (data.sleep[target] != null) return;

  // scan all localStorage keys
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (!k || !k.startsWith("tracker-")) continue;

    try {
      const old = JSON.parse(localStorage.getItem(k));
      if (old && old.sleep) {
        // case 1: stored as YYYY-MM-DD
        if (old.sleep[target] != null) {
          data.sleep[target] = old.sleep[target];
          break;
        }
        // case 2: stored as day number
        if (old.sleep["1"] != null) {
          data.sleep[target] = old.sleep["1"];
          break;
        }
      }
    } catch(e){}
  }

  save();
})();
  habits:Array(5).fill().map(()=>({name:"",checks:{}})),
  sleep:{} // stored as YYYY-MM-DD
};

/* ---- MIGRATE OLD SLEEP DATA (FIXES 1 JAN) ---- */
for(let d in data.sleep){
  if(!d.includes("-")){
    const k=`${Y}-${String(M+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    data.sleep[k]=data.sleep[d];
    delete data.sleep[d];
  }
}

function save(){localStorage.setItem(KEY,JSON.stringify(data));render();}

function dateKey(day){
  return `${Y}-${String(M+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
}

/* -------- HABITS -------- */
function addHabit(){data.habits.push({name:"",checks:{}});save();}
function removeHabit(i){data.habits.splice(i,1);save();}
function toggleHabit(i,d){data.habits[i].checks[d]=!data.habits[i].checks[d];save();}

function renderHabits(){
  habitTable.innerHTML="";
  let h="<tr><th>Habit</th>";
  for(let d=1;d<=DAYS;d++){
    const sep=new Date(Y,M,d).getDay()===0;
    h+=`<th class="${sep?'week-sep':''}">${d}</th>`;
  }
  h+="</tr>";
  habitTable.innerHTML=h;

  let done=0;
  data.habits.forEach((hb,i)=>{
    let r=`<tr><td>
      <input class="inline" value="${hb.name}"
      placeholder="Enter habit"
      oninput="data.habits[${i}].name=this.value;save()">
      <span class="remove-btn" onclick="removeHabit(${i})">Ã—</span>
    </td>`;
    for(let d=1;d<=DAYS;d++){
      const isToday=d===TODAY;
      const sep=new Date(Y,M,d).getDay()===0;
      if(isToday&&hb.checks[d])done++;
      r+=`<td class="cell ${isToday?'today':'locked'} ${sep?'week-sep':''}"
        onclick="${isToday?`toggleHabit(${i},${d})`:''}">
        ${hb.checks[d]?'âœ”':''}
      </td>`;
    }
    r+="</tr>";
    habitTable.innerHTML+=r;
  });
  todayProgress.innerText=`Today: ${done}/${data.habits.length}`;
}

/* -------- SLEEP -------- */
function saveSleep(){
  const s=sleepStart.value,e=sleepEnd.value;
  if(!s||!e)return;
  let a=new Date(`1970-01-01T${s}`);
  let b=new Date(`1970-01-01T${e}`);
  if(b<a)b.setDate(b.getDate()+1);
  const hrs=+((b-a)/36e5).toFixed(1);
  data.sleep[dateKey(TODAY)]=hrs;
  sleepValue.innerText=`${hrs} hrs slept`;
  save();
}

function renderSleep(){
  sleepTable.innerHTML="<tr><th>Day</th><th>Hrs</th></tr>";
  let points=[];
  for(let d=1;d<=DAYS;d++){
    const k=dateKey(d);
    const v=data.sleep[k];
    sleepTable.innerHTML+=`<tr><td>${d}</td><td>${v||""}</td></tr>`;
    if(v!=null)points.push({d,v});
  }

  sleepGraph.innerHTML="";
  if(points.length<1)return;
  const w=sleepGraph.clientWidth,h=sleepGraph.clientHeight,p=20,maxH=10;
  let pts=points.map((o,i)=>({
    x:p+i*(w-2*p)/(points.length-1||1),
    y:h-p-(o.v/maxH)*(h-2*p)
  }));

  sleepGraph.innerHTML+=`<line x1="${p}" y1="${p}" x2="${p}" y2="${h-p}" stroke="currentColor"/>`;
  sleepGraph.innerHTML+=`<line x1="${p}" y1="${h-p}" x2="${w-p}" y2="${h-p}" stroke="currentColor"/>`;
  if(pts.length>1)
    sleepGraph.innerHTML+=`<polyline points="${pts.map(p=>`${p.x},${p.y}`).join(" ")}" fill="none" stroke="currentColor"/>`;
  pts.forEach(p=>sleepGraph.innerHTML+=`<circle cx="${p.x}" cy="${p.y}" r="3" fill="currentColor"/>`);
}

/* -------- CLOCK -------- */
setInterval(()=>{
  dateTime.innerText=new Date().toLocaleDateString()+" "+
  new Date().toLocaleTimeString([],{
    hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true
  });
},1000);

function render(){renderHabits();renderSleep();}
render();
</script>

</body>
</html>
