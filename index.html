<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Personal Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --bg:#000;
  --fg:#fff;
  --accent:#4da6ff;
  --danger:#ff4d4d;
}
body {
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui, sans-serif;
}
h2 { color:var(--accent); margin:10px 0 }
section {
  border:1px solid #444;
  border-radius:12px;
  padding:12px;
  margin:12px;
}
canvas { background:#000 }
input, select, button {
  background:#111;
  color:#fff;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
}
button { cursor:pointer }
.small { font-size:12px; opacity:.7 }
.flex { display:flex; gap:16px; flex-wrap:wrap }
</style>
</head>
<body>

<section>
<h2>Habits</h2>
<div class="small">Click any box to toggle</div>
<canvas id="habitGrid" width="1200" height="220"></canvas>
</section>

<section>
<h2>Sleep</h2>

<div class="flex">
  <div>
    <label>Slept at</label><br>
    <input type="time" id="sleepStart">
  </div>
  <div>
    <label>Woke up at</label><br>
    <input type="time" id="sleepEnd">
  </div>
  <div>
    <label>Date</label><br>
    <input type="date" id="sleepDate">
  </div>
  <div style="align-self:end">
    <button onclick="saveSleep()">Save</button>
  </div>
</div>

<br>

<canvas id="sleepLine" width="1100" height="260"></canvas>

<br>

<div class="flex" id="pieContainer"></div>

</section>

<script>
/* ---------- STORAGE ---------- */
const store = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load = (k,d)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));

/* ---------- DATE HELPERS ---------- */
const now = new Date();
const year = now.getFullYear();
const month = now.getMonth();
const daysInMonth = new Date(year,month+1,0).getDate();

/* ---------- HABITS ---------- */
const habitCanvas = document.getElementById("habitGrid");
const hctx = habitCanvas.getContext("2d");
let habits = load("habits",Array(5).fill().map(()=>Array(daysInMonth).fill(false)));

function drawHabits(){
  hctx.clearRect(0,0,habitCanvas.width,habitCanvas.height);
  const cell=28;
  for(let d=0;d<daysInMonth;d++){
    hctx.fillText(d+1,80+d*cell,20);
  }
  habits.forEach((row,r)=>{
    for(let d=0;d<daysInMonth;d++){
      const x=80+d*cell,y=40+r*cell;
      hctx.strokeRect(x,y,cell,cell);
      if(row[d]){
        hctx.fillText("âœ“",x+8,y+20);
      }
    }
  });
}
habitCanvas.onclick=e=>{
  const rect=habitCanvas.getBoundingClientRect();
  const x=e.clientX-rect.left-80;
  const y=e.clientY-rect.top-40;
  const d=Math.floor(x/28);
  const r=Math.floor(y/28);
  if(d>=0&&d<daysInMonth&&habits[r]){
    habits[r][d]=!habits[r][d];
    store("habits",habits);
    drawHabits();
  }
};
drawHabits();

/* ---------- SLEEP DATA ---------- */
let sleepData = load("sleepData",{});

function calcHours(s,e){
  let [sh,sm]=s.split(":").map(Number);
  let [eh,em]=e.split(":").map(Number);
  let start=sh+sm/60;
  let end=eh+em/60;
  if(end<start) end+=24;
  return +(end-start).toFixed(1);
}

function saveSleep(){
  const d=document.getElementById("sleepDate").value;
  const s=document.getElementById("sleepStart").value;
  const e=document.getElementById("sleepEnd").value;
  if(!d||!s||!e) return;
  sleepData[d]=calcHours(s,e);
  store("sleepData",sleepData);
  drawSleep();
}

/* ---------- LINE GRAPH ---------- */
const line=document.getElementById("sleepLine");
const lctx=line.getContext("2d");

function drawSleep(){
  lctx.clearRect(0,0,line.width,line.height);

  const pad=50;
  const maxH=12;
  const step=(line.width-pad*2)/(daysInMonth-1);

  // axes
  lctx.strokeStyle="#888";
  lctx.beginPath();
  lctx.moveTo(pad,pad);
  lctx.lineTo(pad,line.height-pad);
  lctx.lineTo(line.width-pad,line.height-pad);
  lctx.stroke();

  // y labels
  for(let h=6;h<=12;h++){
    const y=line.height-pad-(h/maxH)*(line.height-pad*2);
    lctx.fillText(h,pad-25,y+4);
    lctx.strokeStyle="#222";
    lctx.beginPath();lctx.moveTo(pad,y);lctx.lineTo(line.width-pad,y);lctx.stroke();
  }

  // goal line
  const gy=line.height-pad-(8/maxH)*(line.height-pad*2);
  lctx.strokeStyle="red";
  lctx.setLineDash([5,5]);
  lctx.beginPath();lctx.moveTo(pad,gy);lctx.lineTo(line.width-pad,gy);lctx.stroke();
  lctx.setLineDash([]);
  lctx.fillStyle="red";
  lctx.fillText("Goal: 8 hrs",pad+5,gy-5);

  // plot
  lctx.strokeStyle="#fff";
  lctx.beginPath();
  let first=true;
  for(let d=1;d<=daysInMonth;d++){
    const key=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    if(sleepData[key]){
      const x=pad+(d-1)*step;
      const y=line.height-pad-(sleepData[key]/maxH)*(line.height-pad*2);
      first?lctx.moveTo(x,y):lctx.lineTo(x,y);
      first=false;
      lctx.fillRect(x-2,y-2,4,4);
    }
  }
  lctx.stroke();

  // x labels
  for(let d=1;d<=daysInMonth;d++){
    const x=pad+(d-1)*step;
    if(d%2===1) lctx.fillText(d,x-4,line.height-pad+15);
  }

  drawPies();
}

/* ---------- PIE CHARTS ---------- */
function drawPies(){
  const cont=document.getElementById("pieContainer");
  cont.innerHTML="";
  let week=[];
  Object.entries(sleepData).forEach(([k,v])=>{
    const day=new Date(k).getDate();
    week.push({day,v});
    if(new Date(k).getDay()===0){
      makePie(week);
      week=[];
    }
  });
  if(week.length) makePie(week);
}

function makePie(data){
  const avg=(data.reduce((a,b)=>a+b.v,0)/data.length).toFixed(1);
  const c=document.createElement("canvas");
  c.width=200;c.height=200;
  const ctx=c.getContext("2d");
  let ang=0;
  const colors=["#4da6ff","#ffcc00","#ff6666","#66ff99","#9966ff","#00ffff","#ff9966"];
  data.forEach((d,i)=>{
    const a=(d.v/24)*Math.PI*2;
    ctx.fillStyle=colors[i%colors.length];
    ctx.beginPath();
    ctx.moveTo(100,100);
    ctx.arc(100,100,90,ang,ang+a);
    ctx.fill();
    ang+=a;
  });
  ctx.fillStyle="#fff";
  ctx.font="14px sans-serif";
  ctx.textAlign="center";
  ctx.fillText(`Avg ${avg}h`,100,105);
  cont.appendChild(c);
}

drawSleep();
</script>

</body>
</html>
